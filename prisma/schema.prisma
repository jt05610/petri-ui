datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id    String @id @default(cuid())
  email String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  password Password?
  nets     Net[]
}

model Password {
  hash String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique
}

enum NetType {
  SYSTEM
  ACTION
  SEQUENTIAL_RUN
  DISTRIBUTED_RUN
}

model Net {
  id          String          @id @default(uuid())
  type        NetType         @default(SYSTEM)
  name        String
  description String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  author      User            @relation(fields: [authorID], references: [id])
  authorID    String
  arcs        Arc[]
  places      NetPlace[]
  transitions NetTransition[]
  parent      Net?            @relation("NetChildren", fields: [parentID], references: [id])
  parentID    String?
  children    Net[]           @relation("NetChildren")
}

model Place {
  id          String     @id @default(uuid())
  name        String
  description String?
  condition   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  arcs        Arc[]
  bound       Int
  nets        NetPlace[]
}

model NetPlace {
  net     Net    @relation(fields: [netID], references: [id])
  netID   String
  place   Place  @relation(fields: [placeID], references: [id])
  placeID String

  @@id([netID, placeID])
}

model Transition {
  id          String              @id @default(uuid())
  condition   String?
  description String?
  name        String
  arcs        Arc[]
  events      LabeledTransition[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  nets        NetTransition[]
}

model NetTransition {
  net          Net        @relation(fields: [netID], references: [id])
  netID        String
  transition   Transition @relation(fields: [transitionID], references: [id])
  transitionID String

  @@id([netID, transitionID])
}

model Arc {
  id           String     @id @default(uuid())
  net          Net        @relation(fields: [netID], references: [id])
  netID        String
  fromPlace    Boolean
  place        Place      @relation(fields: [placeID], references: [id])
  placeID      String
  transition   Transition @relation(fields: [transitionID], references: [id])
  transitionID String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Field {
  id        String   @id @default(uuid())
  name      String
  type      String
  condition String?
  event     Event    @relation(fields: [eventID], references: [id])
  eventID   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          String              @id @default(uuid())
  transitions LabeledTransition[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  Field       Field[]
}

model LabeledTransition {
  label        String
  transition   Transition @relation(fields: [transitionID], references: [id])
  transitionID String
  event        Event      @relation(fields: [eventID], references: [id])
  eventID      String

  @@id([transitionID, eventID])
}
